"""
–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Perplexity API
–ü–æ–∏—Å–∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
"""

import requests
import json
import logging
import time
from typing import List, Dict, Optional
from datetime import datetime, timedelta

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class PerplexityError(Exception):
    """–ö–∞—Å—Ç–æ–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ Perplexity API"""
    pass


class PerplexityClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Perplexity API"""
    
    def __init__(self, api_key: str):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
        
        Args:
            api_key: API –∫–ª—é—á Perplexity
        """
        if not api_key:
            raise ValueError("API –∫–ª—é—á Perplexity –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
            
        self.api_key = api_key
        self.base_url = "https://api.perplexity.ai"
        self.model = "sonar-medium-online"
        self.timeout = 30
        self.max_retries = 3
        self.retry_delay = 1
        
        logger.info("PerplexityClient –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def search_ticker_news(self, ticker: str, hours: int = 24) -> List[Dict]:
        """
        –ü–æ–∏—Å–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ —Ç–∏–∫–µ—Ä—É –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —á–∞—Å–æ–≤
        
        Args:
            ticker: –¢–∏–∫–µ—Ä –∞–∫—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, SBER, GAZP, YNDX)
            hours: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 24)
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –Ω–æ–≤–æ—Å—Ç—è–º–∏
        """
        if not ticker:
            raise ValueError("–¢–∏–∫–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        
        logger.info(f"–ü–æ–∏—Å–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è —Ç–∏–∫–µ—Ä–∞ {ticker} –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {hours} —á–∞—Å–æ–≤")
        
        query = self._build_search_query(ticker, hours)
        
        for attempt in range(self.max_retries):
            try:
                response = self._make_request(query)
                news_data = self._parse_response(response)
                
                logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(news_data)} –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è {ticker}")
                return news_data
                
            except PerplexityError as e:
                logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{self.max_retries} –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}")
                if attempt < self.max_retries - 1:
                    time.sleep(self.retry_delay)
                else:
                    logger.error(f"–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã –¥–ª—è {ticker}")
                    raise
        
        return []
    
    def _build_search_query(self, ticker: str, hours: int) -> str:
        """
        –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        
        Args:
            ticker: –¢–∏–∫–µ—Ä –∞–∫—Ü–∏–∏
            hours: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤
            
        Returns:
            –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        """
        # –†–∞—Å—à–∏—Ä—è–µ–º –ø–æ–∏—Å–∫ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è
        company_names = {
            'SBER': '–°–±–µ—Ä–±–∞–Ω–∫ –°–±–µ—Ä',
            'GAZP': '–ì–∞–∑–ø—Ä–æ–º',
            'YNDX': '–Ø–Ω–¥–µ–∫—Å Yandex',
            'LKOH': '–õ—É–∫–æ–π–ª',
            'NVTK': '–ù–æ–≤–∞—Ç—ç–∫',
            'ROSN': '–†–æ—Å–Ω–µ—Ñ—Ç—å',
            'MGNT': '–ú–∞–≥–Ω–∏—Ç',
            'MTSS': '–ú–¢–°',
            'AFLT': '–ê—ç—Ä–æ—Ñ–ª–æ—Ç'
        }
        
        company = company_names.get(ticker.upper(), ticker)
        
        query = f"""
        –ù–∞–π–¥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –∑–∞ {hours} —á–∞—Å–æ–≤ –æ –∫–æ–º–ø–∞–Ω–∏–∏ {company} ({ticker}).
        –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Ç: —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –∫–æ—Ç–∏—Ä–æ–≤–∫–∏ –∞–∫—Ü–∏–π, –≤–∞–∂–Ω—ã–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è,
        —Å–ª–∏—è–Ω–∏—è –∏ –ø–æ–≥–ª–æ—â–µ–Ω–∏—è, —Ä–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≥–Ω–æ–∑—ã.
        –§–æ–∫—É—Å –Ω–∞ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º —Ä—ã–Ω–∫–µ, –Ω–æ –≤–∫–ª—é—á–∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –µ—Å–ª–∏ –æ–Ω–∏ –≤–ª–∏—è—é—Ç –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—é.
        """
        
        logger.debug(f"–ü–æ—Å—Ç—Ä–æ–µ–Ω –∑–∞–ø—Ä–æ—Å: {query[:100]}...")
        return query
    
    def _make_request(self, query: str) -> Dict:
        """
        –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ Perplexity API
        
        Args:
            query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            
        Returns:
            –û—Ç–≤–µ—Ç API –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å–ª–æ–≤–∞—Ä—è
        """
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
        
        payload = {
            "model": self.model,
            "messages": [
                {
                    "role": "user",
                    "content": query
                }
            ],
            "return_citations": True,
            "search_domain_filter": ["perplexity.ai"],
            "temperature": 0.1,
            "max_tokens": 2000
        }
        
        try:
            logger.debug(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ {self.base_url}/chat/completions")
            
            response = requests.post(
                f"{self.base_url}/chat/completions",
                headers=headers,
                json=payload,
                timeout=self.timeout
            )
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
            if response.status_code == 401:
                raise PerplexityError("–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á Perplexity")
            elif response.status_code == 429:
                raise PerplexityError("–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ Perplexity API")
            elif response.status_code >= 400:
                raise PerplexityError(f"–û—à–∏–±–∫–∞ API: {response.status_code} - {response.text}")
            
            response.raise_for_status()
            
            return response.json()
            
        except requests.exceptions.Timeout:
            raise PerplexityError(f"–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ ({self.timeout}s)")
        except requests.exceptions.ConnectionError:
            raise PerplexityError("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Perplexity API")
        except requests.exceptions.RequestException as e:
            raise PerplexityError(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}")
        except json.JSONDecodeError:
            raise PerplexityError("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç–≤–µ—Ç –æ—Ç API")
    
    def _parse_response(self, response: Dict) -> List[Dict]:
        """
        –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ Perplexity API
        
        Args:
            response: –û—Ç–≤–µ—Ç –æ—Ç API
            
        Returns:
            –°–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –≤ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        """
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
            content = response.get("choices", [{}])[0].get("message", {}).get("content", "")
            citations = response.get("citations", [])
            
            if not content:
                logger.warning("–ü—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –æ—Ç–≤–µ—Ç–µ Perplexity")
                return []
            
            # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
            news_items = []
            
            # –û—Å–Ω–æ–≤–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            main_news = {
                "title": "–û–±–∑–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π –æ—Ç Perplexity",
                "content": content,
                "source": "Perplexity AI",
                "url": "",
                "timestamp": datetime.now().isoformat(),
                "citations": citations,
                "type": "aggregated"
            }
            
            news_items.append(main_news)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–∑ citations
            for i, citation in enumerate(citations[:5]):  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 5 –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
                if isinstance(citation, str) and citation.startswith("http"):
                    citation_news = {
                        "title": f"–ò—Å—Ç–æ—á–Ω–∏–∫ {i+1}",
                        "content": "",
                        "source": citation,
                        "url": citation,
                        "timestamp": datetime.now().isoformat(),
                        "type": "citation"
                    }
                    news_items.append(citation_news)
            
            logger.info(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {len(news_items)} –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤")
            return news_items
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞: {e}")
            return []
    
    def test_connection(self) -> bool:
        """
        –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Perplexity API
        
        Returns:
            True –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–µ, False –∏–Ω–∞—á–µ
        """
        try:
            logger.info("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Perplexity API...")
            
            # –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
            test_news = self.search_ticker_news("SBER", hours=1)
            
            if test_news:
                logger.info("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Perplexity API —É—Å–ø–µ—à–Ω–æ!")
                return True
            else:
                logger.warning("‚ö†Ô∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –µ—Å—Ç—å, –Ω–æ –Ω–æ–≤–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
                return True  # API —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ—Å—Ç–æ –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Perplexity API: {e}")
            return False


def main():
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞"""
    import os
    from dotenv import load_dotenv
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    load_dotenv()
    
    api_key = os.getenv("PERPLEXITY_API_KEY")
    
    if not api_key:
        print("‚ùå PERPLEXITY_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!")
        return
    
    print("üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Perplexity API...")
    
    try:
        client = PerplexityClient(api_key)
        
        # –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if client.test_connection():
            print("‚úÖ –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!")
        else:
            print("‚ùå –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –ø—Ä–æ—à–µ–ª!")
            return
        
        # –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
        print("\nüîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è SBER...")
        news = client.search_ticker_news("SBER", hours=24)
        
        if news:
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(news)} –Ω–æ–≤–æ—Å—Ç–µ–π!")
            print("\nüì∞ –ü–µ—Ä–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å:")
            print(f"–ó–∞–≥–æ–ª–æ–≤–æ–∫: {news[0]['title']}")
            print(f"–ò—Å—Ç–æ—á–Ω–∏–∫: {news[0]['source']}")
            print(f"–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: {news[0]['content'][:200]}...")
        else:
            print("‚ö†Ô∏è –ù–æ–≤–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")


if __name__ == "__main__":
    main()