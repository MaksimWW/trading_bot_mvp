–°–æ–∑–¥–∞–π —Ñ–∞–π–ª src/portfolio_analytics.py —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:

"""
Portfolio Analytics –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞.

–†–∞—Å—á–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –º–µ—Ç—Ä–∏–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è: Sharpe ratio, Sortino ratio, 
–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞, VaR, –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑.
"""

import logging
import numpy as np
import pandas as pd
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple
from dataclasses import dataclass

from portfolio_manager import PortfolioManager
from tinkoff_client import TinkoffClient


logger = logging.getLogger(__name__)


@dataclass
class PortfolioMetrics:
    """–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ—Ç—Ä–∏–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è."""
    # –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å
    total_return: float  # –û–±—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å %
    annualized_return: float  # –ì–æ–¥–æ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å %
    
    # –†–∏—Å–∫-–º–µ—Ç—Ä–∏–∫–∏
    volatility: float  # –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å %
    max_drawdown: float  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞ %
    sharpe_ratio: float  # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞
    sortino_ratio: float  # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –°–æ—Ä—Ç–∏–Ω–æ
    
    # VaR –º–µ—Ç—Ä–∏–∫–∏
    var_95: float  # Value at Risk 95%
    var_99: float  # Value at Risk 99%
    
    # –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
    avg_correlation: float  # –°—Ä–µ–¥–Ω—è—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–æ–≤
    diversification_ratio: float  # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    analysis_period_days: int
    positions_count: int
    calculation_timestamp: datetime


class PortfolioAnalytics:
    """–†–∞—Å—á–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –º–µ—Ç—Ä–∏–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è."""
    
    def __init__(self, portfolio_manager: PortfolioManager = None):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Portfolio Analytics."""
        self.portfolio_manager = portfolio_manager or PortfolioManager()
        self.tinkoff_client = TinkoffClient()
        self.risk_free_rate = 0.15  # 15% –≥–æ–¥–æ–≤—ã—Ö - –∫–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§
        
        logger.info("Portfolio Analytics –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    async def calculate_portfolio_metrics(self, days: int = 30) -> PortfolioMetrics:
        """
        –†–∞—Å—á–µ—Ç –ø–æ–ª–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è.
        
        Args:
            days: –ü–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ –¥–Ω—è—Ö
            
        Returns:
            PortfolioMetrics —Å –ø–æ–ª–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º
        """
        logger.info(f"–ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è –∑–∞ {days} –¥–Ω–µ–π")
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ä—Ç—Ñ–µ–ª—å
            portfolio = self.portfolio_manager.get_portfolio_summary()
            positions = portfolio["positions"]
            
            if not positions:
                return self._create_empty_metrics(days)
            
            # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π
            historical_data = await self._get_historical_data(positions, days)
            
            if not historical_data:
                return self._create_empty_metrics(days)
            
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
            returns_data = self._calculate_returns(historical_data, positions)
            risk_metrics = self._calculate_risk_metrics(returns_data)
            correlation_metrics = self._calculate_correlation_metrics(historical_data)
            
            # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏
            metrics = PortfolioMetrics(
                # –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å
                total_return=returns_data["total_return"],
                annualized_return=returns_data["annualized_return"],
                
                # –†–∏—Å–∫
                volatility=risk_metrics["volatility"],
                max_drawdown=risk_metrics["max_drawdown"],
                sharpe_ratio=risk_metrics["sharpe_ratio"],
                sortino_ratio=risk_metrics["sortino_ratio"],
                
                # VaR
                var_95=risk_metrics["var_95"],
                var_99=risk_metrics["var_99"],
                
                # –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
                avg_correlation=correlation_metrics["avg_correlation"],
                diversification_ratio=correlation_metrics["diversification_ratio"],
                
                # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                analysis_period_days=days,
                positions_count=len(positions),
                calculation_timestamp=datetime.now()
            )
            
            logger.info(f"–ú–µ—Ç—Ä–∏–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã: Sharpe {metrics.sharpe_ratio:.2f}, "
                       f"Max DD {metrics.max_drawdown:.1%}")
            
            return metrics
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è: {e}")
            return self._create_error_metrics(days, str(e))
    
    async def _get_historical_data(self, positions: List[Dict], days: int) -> Dict[str, pd.DataFrame]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π."""
        historical_data = {}
        
        for position in positions:
            ticker = position["ticker"]
            try:
                # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω—ã
                prices = await self.tinkoff_client.get_historical_prices(ticker, days + 10)
                
                if prices and len(prices) >= days:
                    df = pd.DataFrame(prices)
                    df["date"] = pd.to_datetime(df["date"])
                    df.set_index("date", inplace=True)
                    df.sort_index(inplace=True)
                    
                    # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏
                    historical_data[ticker] = df.tail(days)
                    
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è {ticker}: {e}")
                continue
        
        return historical_data
    
    def _calculate_returns(self, historical_data: Dict[str, pd.DataFrame], 
                          positions: List[Dict]) -> Dict:
        """–†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è."""
        if not historical_data:
            return {"total_return": 0.0, "annualized_return": 0.0, "daily_returns": []}
        
        # –°–æ–∑–¥–∞–µ–º –ø–æ—Ä—Ç—Ñ–µ–ª—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Å–æ–≤ –ø–æ–∑–∏—Ü–∏–π
        portfolio_values = []
        dates = None
        
        for ticker, df in historical_data.items():
            # –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–∫–µ—Ä–∞
            position = next((p for p in positions if p["ticker"] == ticker), None)
            if not position:
                continue
            
            # –í–µ—Å –ø–æ–∑–∏—Ü–∏–∏ –≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ
            weight = position["current_value"] / sum(p["current_value"] for p in positions)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤–∑–≤–µ—à–µ–Ω–Ω—ã–µ —Ü–µ–Ω—ã
            if dates is None:
                dates = df.index
                portfolio_values = df["price"] * weight
            else:
                # –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∞—Ç—ã
                aligned_df = df.reindex(dates, method="ffill")
                portfolio_values += aligned_df["price"] * weight
        
        if len(portfolio_values) == 0:
            return {"total_return": 0.0, "annualized_return": 0.0, "daily_returns": []}
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
        portfolio_series = pd.Series(portfolio_values, index=dates)
        daily_returns = portfolio_series.pct_change().dropna()
        
        # –û–±—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å
        total_return = (portfolio_series.iloc[-1] / portfolio_series.iloc[0] - 1) * 100
        
        # –ì–æ–¥–æ–≤–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å
        days_count = len(portfolio_series)
        annualized_return = ((1 + total_return/100) ** (365/days_count) - 1) * 100
        
        return {
            "total_return": total_return,
            "annualized_return": annualized_return,
            "daily_returns": daily_returns.tolist(),
            "portfolio_series": portfolio_series
        }
    
    def _calculate_risk_metrics(self, returns_data: Dict) -> Dict:
        """–†–∞—Å—á–µ—Ç —Ä–∏—Å–∫-–º–µ—Ç—Ä–∏–∫."""
        daily_returns = returns_data.get("daily_returns", [])
        
        if not daily_returns or len(daily_returns) < 2:
            return {
                "volatility": 0.0,
                "max_drawdown": 0.0,
                "sharpe_ratio": 0.0,
                "sortino_ratio": 0.0,
                "var_95": 0.0,
                "var_99": 0.0
            }
        
        returns_array = np.array(daily_returns)
        portfolio_series = returns_data.get("portfolio_series")
        
        # –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (–≥–æ–¥–æ–≤–∞—è)
        volatility = np.std(returns_array) * np.sqrt(252) * 100
        
        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞
        max_drawdown = 0.0
        if portfolio_series is not None and len(portfolio_series) > 1:
            cumulative = (1 + pd.Series(daily_returns)).cumprod()
            running_max = cumulative.expanding().max()
            drawdown = (cumulative - running_max) / running_max
            max_drawdown = abs(drawdown.min()) * 100
        
        # Sharpe ratio
        mean_return = np.mean(returns_array) * 252  # –ì–æ–¥–æ–≤–∞—è
        daily_risk_free = (self.risk_free_rate / 100) / 252
        excess_returns = returns_array - daily_risk_free
        sharpe_ratio = np.mean(excess_returns) * np.sqrt(252) / np.std(returns_array) if np.std(returns_array) > 0 else 0
        
        # Sortino ratio (—Ç–æ–ª—å–∫–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è)
        negative_returns = returns_array[returns_array < daily_risk_free]
        downside_std = np.std(negative_returns) if len(negative_returns) > 0 else np.std(returns_array)
        sortino_ratio = np.mean(excess_returns) * np.sqrt(252) / downside_std if downside_std > 0 else 0
        
        # VaR (Value at Risk)
        var_95 = np.percentile(returns_array, 5) * 100  # 5% —Ö—É–¥—à–∏–µ –¥–Ω–∏
        var_99 = np.percentile(returns_array, 1) * 100  # 1% —Ö—É–¥—à–∏–µ –¥–Ω–∏
        
        return {
            "volatility": volatility,
            "max_drawdown": max_drawdown,
            "sharpe_ratio": sharpe_ratio,
            "sortino_ratio": sortino_ratio,
            "var_95": var_95,
            "var_99": var_99
        }
    
    def _calculate_correlation_metrics(self, historical_data: Dict[str, pd.DataFrame]) -> Dict:
        """–†–∞—Å—á–µ—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫."""
        if len(historical_data) < 2:
            return {
                "avg_correlation": 0.0,
                "diversification_ratio": 1.0
            }
        
        # –°–æ–∑–¥–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–µ–π
        returns_matrix = pd.DataFrame()
        
        for ticker, df in historical_data.items():
            if len(df) > 1:
                daily_returns = df["price"].pct_change().dropna()
                returns_matrix[ticker] = daily_returns
        
        if returns_matrix.empty or len(returns_matrix.columns) < 2:
            return {
                "avg_correlation": 0.0,
                "diversification_ratio": 1.0
            }
        
        # –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞
        correlation_matrix = returns_matrix.corr()
        
        # –°—Ä–µ–¥–Ω—è—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è (–∏—Å–∫–ª—é—á–∞—è –¥–∏–∞–≥–æ–Ω–∞–ª—å)
        correlations = []
        for i in range(len(correlation_matrix)):
            for j in range(i+1, len(correlation_matrix)):
                correlations.append(correlation_matrix.iloc[i, j])
        
        avg_correlation = np.mean(correlations) if correlations else 0.0
        
        # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
        # Simplified: 1 - average_correlation (—á–µ–º –º–µ–Ω—å—à–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è, —Ç–µ–º –ª—É—á—à–µ –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è)
        diversification_ratio = max(0.0, 1.0 - abs(avg_correlation))
        
        return {
            "avg_correlation": avg_correlation,
            "diversification_ratio": diversification_ratio
        }
    
    def _create_empty_metrics(self, days: int) -> PortfolioMetrics:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø—É—Å—Ç—ã—Ö –º–µ—Ç—Ä–∏–∫ –¥–ª—è –ø–æ—Ä—Ç—Ñ–µ–ª—è –±–µ–∑ –ø–æ–∑–∏—Ü–∏–π."""
        return PortfolioMetrics(
            total_return=0.0,
            annualized_return=0.0,
            volatility=0.0,
            max_drawdown=0.0,
            sharpe_ratio=0.0,
            sortino_ratio=0.0,
            var_95=0.0,
            var_99=0.0,
            avg_correlation=0.0,
            diversification_ratio=1.0,
            analysis_period_days=days,
            positions_count=0,
            calculation_timestamp=datetime.now()
        )
    
    def _create_error_metrics(self, days: int, error_message: str) -> PortfolioMetrics:
        """–°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ."""
        logger.error(f"–°–æ–∑–¥–∞–Ω–∏–µ error metrics: {error_message}")
        return self._create_empty_metrics(days)
    
    def format_metrics_for_telegram(self, metrics: PortfolioMetrics) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram."""
        if metrics.positions_count == 0:
            return """
üìä *–ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–û–†–¢–§–ï–õ–Ø*

üíº *–°—Ç–∞—Ç—É—Å:* –ü–æ—Ä—Ç—Ñ–µ–ª—å –ø—É—Å—Ç
üìÖ *–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞:* {metrics.analysis_period_days} –¥–Ω–µ–π

üí° *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:* –î–æ–±–∞–≤—å—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞
- `/buy TICKER QUANTITY` - –ø–æ–∫—É–ø–∫–∞ –∞–∫—Ü–∏–π
- `/ai_analysis TICKER` - –∞–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π
""".format(metrics=metrics)
        
        # –≠–º–æ–¥–∑–∏ –¥–ª—è –º–µ—Ç—Ä–∏–∫
        return_emoji = "üìà" if metrics.total_return >= 0 else "üìâ"
        sharpe_emoji = "üü¢" if metrics.sharpe_ratio > 1.0 else "üü°" if metrics.sharpe_ratio > 0.5 else "üî¥"
        risk_emoji = "üü¢" if metrics.max_drawdown < 5 else "üü°" if metrics.max_drawdown < 10 else "üî¥"
        
        text = f"""
üìä *–ê–ù–ê–õ–ò–¢–ò–ö–ê –ü–û–†–¢–§–ï–õ–Ø*

üí∞ *–î–û–•–û–î–ù–û–°–¢–¨:*
{return_emoji} *–û–±—â–∞—è:* {metrics.total_return:+.2f}%
üìà *–ì–æ–¥–æ–≤–∞—è:* {metrics.annualized_return:+.2f}%

‚ö° *–†–ò–°–ö-–ú–ï–¢–†–ò–ö–ò:*
üìä *–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å:* {metrics.volatility:.1f}%
{risk_emoji} *–ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞:* {metrics.max_drawdown:.1f}%
{sharpe_emoji} *Sharpe ratio:* {metrics.sharpe_ratio:.2f}
üéØ *Sortino ratio:* {metrics.sortino_ratio:.2f}

üõ°Ô∏è *VALUE AT RISK:*
‚ö†Ô∏è *VaR 95%:* {metrics.var_95:.2f}%
üö® *VaR 99%:* {metrics.var_99:.2f}%

üîó *–î–ò–í–ï–†–°–ò–§–ò–ö–ê–¶–ò–Ø:*
üìä *–°—Ä–µ–¥–Ω—è—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è:* {metrics.avg_correlation:.2f}
üéØ *–ö–æ—ç—Ñ. –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:* {metrics.diversification_ratio:.2f}

üìã *–°–í–û–î–ö–ê:*
- *–ü–æ–∑–∏—Ü–∏–π:* {metrics.positions_count}
- *–ü–µ—Ä–∏–æ–¥:* {metrics.analysis_period_days} –¥–Ω–µ–π
- *–†–∞—Å—á–µ—Ç:* {metrics.calculation_timestamp.strftime('%H:%M:%S %d.%m.%Y')}

üí° *–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:*
- Sharpe > 1.0 = –æ—Ç–ª–∏—á–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Å —É—á–µ—Ç–æ–º —Ä–∏—Å–∫–∞
- Max DD < 5% = –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è
- –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è < 0.5 = —Ö–æ—Ä–æ—à–∞—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è

‚ö†Ô∏è *–î–∏—Å–∫–ª–µ–π–º–µ—Ä:* –ú–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
"""
        
        return text


def main():
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è."""
    import asyncio
    
    async def test_portfolio_analytics():
        print("üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Portfolio Analytics...")
        
        try:
            analytics = PortfolioAnalytics()
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫
            print("üî¢ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—è...")
            metrics = await analytics.calculate_portfolio_metrics(days=30)
            
            print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:")
            print(f"–ü–æ–∑–∏—Ü–∏–π: {metrics.positions_count}")
            print(f"–û–±—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: {metrics.total_return:+.2f}%")
            print(f"Sharpe ratio: {metrics.sharpe_ratio:.2f}")
            print(f"Max drawdown: {metrics.max_drawdown:.1f}%")
            
            print("\nüì± –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è Telegram:")
            telegram_text = analytics.format_metrics_for_telegram(metrics)
            print(telegram_text)
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
    
    asyncio.run(test_portfolio_analytics())


if __name__ == "__main__":
    main()